<!DOCTYPE html>
<html lang="en">
  <head>
    <title>an interactive, non-expert history of American riot as it contributes to legal action</title>
    <style>
      body {
        font-family: 'Times New Roman';
      }

      h1 {
        color: '#e34f4f';
        font-size: 18px;
      }

      h2 {
        color: '#000000';
        font-size: 13px;
      }

      #riot-timeline {
      }
    </style>
  </head>
  <body>
    <h1>an interactive, non-expert history of American riot as it contributes to legal action</h1>
    <h2>created by Clare Palmer and Topher Lin for <i>The World Wide Wrench</i></h2>

    <div id="riot-timeline">
    </div>

    <script src="d3.v2.min.js"></script>
    <script src="timeknots.js"></script>
    <script>
      let url = "https://spreadsheets.google.com/feeds/cells/1sr99iZPH_iDdHwBQwB83_GKOpcbH8pmc2bgj1Nx4doo/1/public/values?alt=json";
      window.fetch(url)
        .then(response => response.json())
        .then(data => {
          let cells = data.feed.entry;

          let keys = [];
          let riotData = [];
          let currentDatum;
          for (let cell of cells) {
            const row = parseInt(cell['gs$cell'].row);
            const col = parseInt(cell['gs$cell'].col);
            const value = cell['gs$cell']['$t'];

            // process header row
            if (row == 1) {
              keys.push(value);

            // process data rows
            } else {
              if (col == 1) {
                if (currentDatum) {
                  riotData.push(currentDatum);
                }
                currentDatum = {};
              }

              const keyIndex = parseInt(col) - 1;
              const key = keys[keyIndex];
              currentDatum[key] = value;
            }
          }

          const keyMappings = {
            'Header':    'name',
            'Year':      'dateStr',
            'Text':      'description',
            'Dot Color': 'color',
          };

          riotData = riotData.map(oldDatum => {
            let newDatum = {};
            for (oldKey in oldDatum) {
              const value = oldDatum[oldKey];
              const newKey = keyMappings[oldKey];
              if (newKey) {
                newDatum[newKey] = value;
              }
              if (newKey == 'dateStr') {
                newDatum.date = value.split('-')[0];
              }
            }
            return newDatum;
          });

          TimeKnots.draw(
            '#riot-timeline',
            riotData,
            {
              color: '#E06666',
              dateFormat: '%Y',
              width: 500,
              showLabels: true,
              labelFormat: '%Y'
            }
          );
        });

    </script>
  </body>
</html>
