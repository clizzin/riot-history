<!DOCTYPE html>
<html lang="en">
  <head>
    <title>an interactive, non-expert history of American riot as it contributes to legal action</title>
    <style>
      h1 {
        color: '#e34f4f';
        font-family: 'Times New Roman';
        font-size: 18px;
      }

      h2 {
        color: '#000000';
        font-family: 'Times New Roman';
        font-size: 13px;
      }

      #riot-timeline {
      }

      .tooltip {
        border: 1px solid black;
        border-radius: 8px 8px;
        padding: 10px;
      }

      .tooltip-img {
        float: left;
        margin-right: 4px;
        width: 150px;
      }
    </style>
  </head>
  <body>
    <h1>an interactive, non-expert history of American riot as it contributes to legal action</h1>
    <h2>created by Clare Palmer and Topher Lin for <i>The World Wide Wrench</i></h2>

    <div id="riot-timeline1">
    </div>

    <div id="riot-timeline2">
    </div>

    <script src="d3.v2.min.js"></script>
    <script src="timeknots.js"></script>
    <script>
      let url = "https://spreadsheets.google.com/feeds/cells/1sr99iZPH_iDdHwBQwB83_GKOpcbH8pmc2bgj1Nx4doo/1/public/values?alt=json";
      window.fetch(url)
        .then(response => response.json())
        .then(data => {
          let cells = data.feed.entry;

          let keys = [];
          let riotData = [];
          let currentDatum;
          for (let cell of cells) {
            const row = parseInt(cell['gs$cell'].row);
            const col = parseInt(cell['gs$cell'].col);
            const value = cell['gs$cell']['$t'];

            // process header row
            if (row == 1) {
              keys.push(value);

            // process data rows
            } else {
              if (col == 1) {
                if (currentDatum) {
                  riotData.push(currentDatum);
                }
                currentDatum = {};
              }

              const keyIndex = parseInt(col) - 1;
              const key = keys[keyIndex];
              currentDatum[key] = value;
            }
          }
          riotData.push(currentDatum);

          const keyMappings = {
            'Header':    'name',
            'Year':      'dateStr',
            'Text':      'description',
            'Dot Color': 'color',
            'Dot Size':  'radius',
            'Media':     'img',
            'The Response': 'responseDescription',
          };

          riotData = riotData.map(oldDatum => {
            let newDatum = {};
            for (oldKey in oldDatum) {
              const value = oldDatum[oldKey];
              const newKey = keyMappings[oldKey];
              if (newKey) {
                newDatum[newKey] = value;
              }
              if (newKey == 'dateStr') {
                newDatum.date = value.split('-')[0];
              }
              if (newKey == 'radius') {
                switch (value.toLowerCase()) {
                  case 'medium':
                    newDatum.radius = 10;
                    break;
                  case 'large':
                    newDatum.radius = 15;
                    break;
                  default:
                    newDatum.radius = 2;
                    break;
                }
              }

              if (newKey == 'responseDescription') {
                newDatum.responseDescription = '\nThe response: ' + newDatum.responseDescription;
              }
            }
            return newDatum;
          });

          riotData.sort(datum => parseInt(datum.date));

          let riotData1 = riotData.slice(0, 54);
          let riotData2 = riotData.slice(54);

          const baseConfig = {
            dateFormat: '%Y',
            showLabels: true,
            labelFormat: '%Y',
            width: Math.max(720, window.innerWidth * 4.0 / 5.0),
          };

          const timeline1Height = 200;
          const verticalDistance = 600;

          TimeKnots.draw(
            '#riot-timeline1',
            riotData1,
            Object.assign(baseConfig, {
              height: timeline1Height,
              tooltipDirectionY: 1,
            }),
          );

          TimeKnots.draw(
            '#riot-timeline2',
            riotData2,
            Object.assign(baseConfig, {
              height: timeline1Height + verticalDistance,
              tooltipDirectionY: -1,
            }),
          );
        });

    </script>
  </body>
</html>
