<!DOCTYPE html>
<html lang="en">
  <head>
    <title>an interactive, non-expert history of American riot as it contributes to legal action</title>
    <style>
      h1 {
        color: '#e34f4f';
        font-family: 'Times New Roman';
        font-size: 18px;
      }

      h2 {
        color: '#000000';
        font-family: 'Times New Roman';
        font-size: 13px;
      }

      #riot-timeline {
      }

      .tooltip-img {
        float: left;
        margin-right: 4px;
        width: 150px;
      }
    </style>
  </head>
  <body>
    <h1>an interactive, non-expert history of American riot as it contributes to legal action</h1>
    <h2>created by Clare Palmer and Topher Lin for <i>The World Wide Wrench</i></h2>

    <div id="riot-timeline">
    </div>

    <script src="d3.v2.min.js"></script>
    <script src="timeknots.js"></script>
    <script>
      let url = "https://spreadsheets.google.com/feeds/cells/1sr99iZPH_iDdHwBQwB83_GKOpcbH8pmc2bgj1Nx4doo/1/public/values?alt=json";
      window.fetch(url)
        .then(response => response.json())
        .then(data => {
          let cells = data.feed.entry;

          let keys = [];
          let riotData = [];
          let currentDatum;
          for (let cell of cells) {
            const row = parseInt(cell['gs$cell'].row);
            const col = parseInt(cell['gs$cell'].col);
            const value = cell['gs$cell']['$t'];

            // process header row
            if (row == 1) {
              keys.push(value);

            // process data rows
            } else {
              if (col == 1) {
                if (currentDatum) {
                  riotData.push(currentDatum);
                }
                currentDatum = {};
              }

              const keyIndex = parseInt(col) - 1;
              const key = keys[keyIndex];
              currentDatum[key] = value;
            }
          }
          riotData.push(currentDatum);

          const keyMappings = {
            'Header':    'name',
            'Year':      'dateStr',
            'Text':      'description',
            'Dot Color': 'color',
            'Dot Size':  'radius',
            'Media':     'img',
          };

          riotData = riotData.map(oldDatum => {
            let newDatum = {};
            for (oldKey in oldDatum) {
              const value = oldDatum[oldKey];
              const newKey = keyMappings[oldKey];
              if (newKey) {
                newDatum[newKey] = value;
              }
              if (newKey == 'dateStr') {
                newDatum.date = value.split('-')[0];
              }
              if (newKey == 'radius') {
                switch (value.toLowerCase()) {
                  case 'small':
                    newDatum.radius = 5;
                    break;
                  case 'large':
                    newDatum.radius = 15;
                    break;
                  default:
                    newDatum.radius = null;
                    break;
                }
              }
            }
            return newDatum;
          });

          TimeKnots.draw(
            '#riot-timeline',
            riotData,
            {
              dateFormat: '%Y',
              width: Math.max(720, window.innerWidth * 3.0 / 4.0),
              height: Math.max(720, window.innerHeight * 3.0 / 4.0),
              showLabels: true,
              labelFormat: '%Y'
            }
          );
        });

    </script>
  </body>
</html>
